import streamlit as st
import pandas as pd
import yfinance as yf

# ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(page_title="æœ€å¼·éŠ˜æŸ„ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ãƒ»ãƒ—ãƒ©ã‚¤ãƒ å®Œå…¨ç‰ˆ", layout="wide")

# --- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ ---
MY_PASSWORD = "stock testa" 
if 'auth' not in st.session_state: st.session_state.auth = False

if not st.session_state.auth:
    st.title("ğŸ”’ èªè¨¼")
    pwd = st.text_input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", type="password")
    if pwd == MY_PASSWORD:
        st.session_state.auth = True
        st.rerun()
    st.stop()

st.title("âš¡ï¸ ãƒ—ãƒ©ã‚¤ãƒ å¸‚å ´ãƒ»å®Œå…¨ç¶²ç¾…ã‚¹ã‚­ãƒ£ãƒ³")
st.caption("æ—¥çµŒ225 ï¼‹ å£²è²·ä»£é‡‘ä¸Šä½ï¼ˆç´„320ç¤¾ï¼‰ã‚’ä¸€æ‹¬ç›£è¦–")

# --- ç›£è¦–ãƒªã‚¹ãƒˆï¼ˆä½å‹é›»å·¥ã€ãƒ•ã‚¸ã‚¯ãƒ©ã€ã‚­ãƒ¼ã‚¨ãƒ³ã‚¹ç­‰ã‚’è¿½åŠ ã—å®Œå…¨ç¶²ç¾…ï¼‰ ---
TARGET_STOCKS = {
    # --- é›»ç·šãƒ»éé‰„ãƒ»é‡‘å±ï¼ˆã“ã“ã‚’è¿½åŠ ï¼ï¼‰ ---
    "5802.T": "ä½å‹é›»å·¥", "5803.T": "ãƒ•ã‚¸ã‚¯ãƒ©", "5801.T": "å¤æ²³é›»å·¥", "5713.T": "ä½å‹é‰±",
    "5711.T": "ä¸‰è±ãƒ", "5714.T": "DOWA", "5706.T": "ä¸‰äº•é‡‘", "5726.T": "å¤§é˜ªãƒã‚¿",
    "5727.T": "æ±é‚¦ãƒã‚¿", "3436.T": "SUMCO", "5938.T": "LIXIL",
    
    # --- åŠå°ä½“ãƒ»é›»æ°—ãƒ»ç²¾å¯† ---
    "8035.T": "æ±ã‚¨ãƒ¬ã‚¯", "6920.T": "ãƒ¬ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒƒã‚¯", "6146.T": "ãƒ‡ã‚£ã‚¹ã‚³", "6857.T": "ã‚¢ãƒ‰ãƒãƒ³ãƒ†ã‚¹ãƒˆ",
    "7735.T": "ã‚¹ã‚¯ãƒªãƒ³", "6723.T": "ãƒ«ãƒã‚µã‚¹", "6526.T": "ã‚½ã‚·ã‚ªãƒã‚¯ã‚¹ãƒˆ", "6315.T": "TOWA",
    "6871.T": "æ—¥æœ¬ãƒã‚¤ã‚¯ãƒ­", "6525.T": "KOKUSAI", "6758.T": "ã‚½ãƒ‹ãƒ¼G", "6501.T": "æ—¥ç«‹",
    "6701.T": "NEC", "6702.T": "å¯Œå£«é€š", "6503.T": "ä¸‰è±é›»æ©Ÿ", "6504.T": "å¯Œå£«é›»æ©Ÿ",
    "6506.T": "å®‰å·é›»æ©Ÿ", "6954.T": "ãƒ•ã‚¡ãƒŠãƒƒã‚¯", "6861.T": "ã‚­ãƒ¼ã‚¨ãƒ³ã‚¹", "6273.T": "SMC",
    "6981.T": "æ‘ç”°è£½", "6762.T": "TDK", "6971.T": "äº¬ã‚»ãƒ©", "6976.T": "å¤ªé™½èª˜é›»",
    "6988.T": "æ—¥æ±é›»å·¥", "6479.T": "ãƒŸãƒãƒ™ã‚¢", "7751.T": "ã‚­ãƒ¤ãƒãƒ³", "7733.T": "ã‚ªãƒªãƒ³ãƒ‘ã‚¹",
    "7741.T": "HOYA", "4901.T": "å¯Œå£«ãƒ•ã‚¤ãƒ«ãƒ ", "6752.T": "ãƒ‘ãƒŠã‚½ãƒ‹ãƒƒã‚¯", "6841.T": "æ¨ªæ²³é›»æ©Ÿ",
    "6645.T": "ã‚ªãƒ ãƒ­ãƒ³", "7701.T": "å³¶æ´¥è£½", "6594.T": "ãƒ‹ãƒ‡ãƒƒã‚¯", "6902.T": "ãƒ‡ãƒ³ã‚½ãƒ¼",

    # --- è‡ªå‹•è»Šãƒ»ã‚¿ã‚¤ãƒ¤ ---
    "7203.T": "ãƒˆãƒ¨ã‚¿", "7267.T": "ãƒ›ãƒ³ãƒ€", "7201.T": "æ—¥ç”£è‡ª", "7270.T": "SUBARU",
    "7269.T": "ã‚¹ã‚ºã‚­", "7211.T": "ä¸‰è±è‡ª", "7202.T": "ã„ã™ã‚", "7259.T": "ã‚¢ã‚¤ã‚·ãƒ³",
    "7261.T": "ãƒãƒ„ãƒ€", "7272.T": "ãƒ¤ãƒãƒç™º", "5108.T": "ãƒ–ãƒªãƒ‚ã‚¹ãƒˆãƒ³",

    # --- æ©Ÿæ¢°ãƒ»é‡å·¥ãƒ»é€ èˆ¹ ---
    "7011.T": "ä¸‰è±é‡å·¥", "7012.T": "å·å´é‡å·¥", "7013.T": "IHI", "6301.T": "ã‚³ãƒãƒ„",
    "6305.T": "æ—¥ç«‹å»ºæ©Ÿ", "6326.T": "ã‚¯ãƒœã‚¿", "6005.T": "ä¸‰æµ¦å·¥æ¥­", "6113.T": "ã‚¢ãƒãƒ€",
    "5631.T": "æ—¥æœ¬è£½é‹¼æ‰€", "7004.T": "æ—¥ç«‹é€ èˆ¹", "6361.T": "èåŸ", "6367.T": "ãƒ€ã‚¤ã‚­ãƒ³",
    "6383.T": "ãƒ€ã‚¤ãƒ•ã‚¯", "6417.T": "SANKYO", "6460.T": "ã‚»ã‚¬ã‚µãƒŸãƒ¼",

    # --- éŠ€è¡Œãƒ»è¨¼åˆ¸ãƒ»ä¿é™º ---
    "8306.T": "ä¸‰è±UFJ", "8316.T": "ä¸‰äº•ä½å‹", "8411.T": "ã¿ãšã»", "8308.T": "ã‚Šããª",
    "8309.T": "ä¸‰äº•ä½å‹ãƒˆãƒ©", "8304.T": "ã‚ãŠãã‚‰", "8331.T": "åƒè‘‰éŠ€", "8354.T": "ãµããŠã‹",
    "7186.T": "ã‚³ãƒ³ã‚³ãƒ«ãƒ‡ã‚£ã‚¢", "8410.T": "ã‚»ãƒ–ãƒ³éŠ€è¡Œ", "8604.T": "é‡æ‘HD", "8601.T": "å¤§å’Œè¨¼åˆ¸",
    "8697.T": "JPX", "8766.T": "æ±äº¬æµ·ä¸Š", "8725.T": "MS&AD", "8630.T": "SOMPO",
    "8750.T": "ç¬¬ä¸€ç”Ÿå‘½", "8795.T": "T&D", "8591.T": "ã‚ªãƒªãƒƒã‚¯ã‚¹", "8253.T": "ã‚¯ãƒ¬ãƒ‡ã‚£ã‚»ã‚¾ãƒ³",
    "7182.T": "ã‚†ã†ã¡ã‚‡",

    # --- å•†ç¤¾ãƒ»å¸å£² ---
    "8058.T": "ä¸‰è±å•†äº‹", "8001.T": "ä¼Šè—¤å¿ ", "8031.T": "ä¸‰äº•ç‰©ç”£", "8002.T": "ä¸¸ç´…",
    "8015.T": "è±Šç”°é€šå•†", "2768.T": "åŒæ—¥", "8053.T": "ä½å‹å•†äº‹", "9983.T": "ãƒ•ã‚¡ã‚¹ãƒˆãƒª",
    "3382.T": "ã‚»ãƒ–ãƒ³&ã‚¢ã‚¤", "8267.T": "ã‚¤ã‚ªãƒ³", "3099.T": "ä¸‰è¶Šä¼Šå‹¢ä¸¹", "3086.T": "Jãƒ•ãƒ­ãƒ³ãƒˆ",
    "8233.T": "é«˜å³¶å±‹", "9984.T": "ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯G", "7532.T": "ãƒ‘ãƒ³ãƒ‘ã‚·HD", "9843.T": "ãƒ‹ãƒˆãƒª",
    "3092.T": "ZOZO", "2670.T": "ABCãƒãƒ¼ãƒˆ",

    # --- é‰„é‹¼ãƒ»åŒ–å­¦ãƒ»ç´ æ ---
    "5401.T": "æ—¥æœ¬è£½é‰„", "5411.T": "JFE", "5406.T": "ç¥æˆ¸é‹¼", "3407.T": "æ—­åŒ–æˆ",
    "3402.T": "æ±ãƒ¬", "3401.T": "å¸äºº", "4188.T": "ä¸‰è±ã‚±ãƒŸ", "4183.T": "ä¸‰äº•åŒ–å­¦",
    "4005.T": "ä½å‹åŒ–å­¦", "4042.T": "æ±ã‚½ãƒ¼", "4061.T": "ãƒ‡ãƒ³ã‚«", "4021.T": "æ—¥ç”£åŒ–å­¦",
    "4063.T": "ä¿¡è¶ŠåŒ–å­¦", "4062.T": "ã‚¤ãƒ“ãƒ‡ãƒ³", "4631.T": "DIC", "4911.T": "è³‡ç”Ÿå ‚",
    "4452.T": "èŠ±ç‹", "5201.T": "AGC", "5233.T": "å¤ªå¹³æ´‹ã‚»ãƒ¡", 

    # --- æµ·é‹ãƒ»é™¸é‹ãƒ»ç©ºé‹ ---
    "9101.T": "æ—¥æœ¬éƒµèˆ¹", "9104.T": "å•†èˆ¹ä¸‰äº•", "9107.T": "å·å´æ±½èˆ¹",
    "9201.T": "JAL", "9202.T": "ANA", "9020.T": "JRæ±æ—¥æœ¬", "9021.T": "JRè¥¿æ—¥æœ¬",
    "9022.T": "JRæ±æµ·", "9064.T": "ãƒ¤ãƒãƒˆHD", "9143.T": "SGHD", "9005.T": "æ±æ€¥",
    "9007.T": "å°ç”°æ€¥", "9009.T": "äº¬æˆ",

    # --- é€šä¿¡ãƒ»ã‚¤ãƒ³ãƒ•ãƒ©ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ ---
    "9432.T": "NTT", "9433.T": "KDDI", "9434.T": "ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯", "9613.T": "NTTãƒ‡ãƒ¼ã‚¿",
    "9501.T": "æ±é›»HD", "9502.T": "ä¸­éƒ¨é›»åŠ›", "9503.T": "é–¢è¥¿é›»åŠ›", "9531.T": "æ±äº¬ã‚¬ã‚¹",
    "9532.T": "å¤§é˜ªã‚¬ã‚¹", "4689.T": "LINEãƒ¤ãƒ•ãƒ¼", "4755.T": "æ¥½å¤©G", "6098.T": "ãƒªã‚¯ãƒ«ãƒ¼ãƒˆ",
    "4661.T": "OLC", "2413.T": "ã‚¨ãƒ ã‚¹ãƒªãƒ¼", "4385.T": "ãƒ¡ãƒ«ã‚«ãƒª", "7974.T": "ä»»å¤©å ‚",
    "9735.T": "ã‚»ã‚³ãƒ ", "9602.T": "æ±å®", "4751.T": "ã‚µã‚¤ãƒãƒ¼",

    # --- åŒ»è–¬ãƒ»é£Ÿå“ ---
    "4502.T": "æ­¦ç”°è–¬å“", "4568.T": "ç¬¬ä¸€ä¸‰å…±", "4519.T": "ä¸­å¤–è£½è–¬", "4503.T": "ã‚¢ã‚¹ãƒ†ãƒ©ã‚¹",
    "4507.T": "å¡©é‡ç¾©", "4523.T": "ã‚¨ãƒ¼ã‚¶ã‚¤", "4578.T": "å¤§å¡šHD", "4528.T": "å°é‡è–¬å“",
    "4151.T": "å”å’Œã‚­ãƒªãƒ³", "2502.T": "ã‚¢ã‚µãƒ’", "2503.T": "ã‚­ãƒªãƒ³", "2914.T": "JT",
    "2801.T": "ã‚­ãƒƒã‚³ãƒ¼ãƒãƒ³", "2802.T": "å‘³ã®ç´ ", "2267.T": "ãƒ¤ã‚¯ãƒ«ãƒˆ", "2282.T": "ãƒ‹ãƒƒãƒãƒ ",
    "2269.T": "æ˜æ²»HD", "2897.T": "æ—¥æ¸…é£Ÿå“",

    # --- å»ºè¨­ãƒ»ä¸å‹•ç”£ ---
    "1925.T": "å¤§å’Œãƒã‚¦ã‚¹", "1928.T": "ç©æ°´ãƒã‚¦ã‚¹", "1801.T": "å¤§æˆå»ºè¨­", "1802.T": "å¤§æ—çµ„",
    "1803.T": "æ¸…æ°´å»ºè¨­", "1812.T": "é¹¿å³¶", "1808.T": "é•·è°·å·¥", "1944.T": "ãã‚“ã§ã‚“",
    "8801.T": "ä¸‰äº•ä¸å‹•ç”£", "8802.T": "ä¸‰è±åœ°æ‰€", "8830.T": "ä½å‹ä¸", "3289.T": "æ±æ€¥ä¸HD"
}

def scan_ranking(stock_dict):
    if st.button('ğŸ“¡ ãƒ—ãƒ©ã‚¤ãƒ å¸‚å ´(å®Œå…¨ç‰ˆ)ã‚’ã‚¹ã‚­ãƒ£ãƒ³', type="primary"):
        msg = st.empty()
        bar = st.progress(0)
        msg.text(f"å…¨{len(stock_dict)}éŠ˜æŸ„ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...ï¼ˆ10ã€œ20ç§’ã»ã©ã‹ã‹ã‚Šã¾ã™ï¼‰")
        
        tickers = list(stock_dict.keys())
        
        try:
            # yfinanceã§ä¸€æ‹¬å–å¾—
            df = yf.download(tickers, period="1d", interval="1d", progress=False, group_by='ticker')
            
            bar.progress(50)
            msg.text("ãƒ©ãƒ³ã‚­ãƒ³ã‚°åˆ†æä¸­...")
            
            results = []
            for ticker in tickers:
                try:
                    name = stock_dict[ticker]
                    
                    if ticker not in df.columns.levels[0]: continue
                    
                    data = df[ticker].iloc[-1]
                    curr = data['Close']
                    op = data['Open']
                    vol = data['Volume']
                    
                    if pd.isna(curr) or pd.isna(op) or op == 0: continue
                    
                    # å¯„ä»˜æ¯”
                    change = (curr - op) / op * 100
                    
                    # åˆ¤å®š
                    status = ""
                    if change > 3.0: status = "ğŸ”¥ğŸ”¥ æ€¥é¨°"
                    elif change > 1.5: status = "ğŸš€ å¼·ã„"
                    elif change > 0.5: status = "ğŸ“ˆ å …èª¿"
                    elif change < -1.5: status = "ğŸ“‰ å¼±ã„"
                    else: status = "-"

                    results.append({
                        "éŠ˜æŸ„å": name,
                        "ã‚³ãƒ¼ãƒ‰": ticker.replace(".T", ""),
                        "å¯„ä»˜æ¯”": change,
                        "ç¾åœ¨å€¤": curr,
                        "åˆ¤å®š": status,
                        "å‡ºæ¥é«˜": vol
                    })
                except: continue
            
            bar.progress(100)
            
            # ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
            rank_df = pd.DataFrame(results)
            if not rank_df.empty:
                # å¯„ä»˜æ¯”é †
                rank_df = rank_df.sort_values(by="å¯„ä»˜æ¯”", ascending=False)
                # ä¸Šæ˜‡éŠ˜æŸ„ã®ã¿
                rank_df = rank_df[rank_df['å¯„ä»˜æ¯”'] > 0]
                
                show_df = pd.DataFrame()
                show_df['éŠ˜æŸ„å'] = rank_df['éŠ˜æŸ„å']
                show_df['ã‚³ãƒ¼ãƒ‰'] = rank_df['ã‚³ãƒ¼ãƒ‰']
                show_df['å¯„ä»˜æ¯”'] = rank_df['å¯„ä»˜æ¯”'].map(lambda x: f"+{x:.2f}%")
                show_df['ç¾åœ¨å€¤'] = rank_df['ç¾åœ¨å€¤'].map(lambda x: f"{x:,.0f}")
                show_df['åˆ¤å®š'] = rank_df['åˆ¤å®š']
                
                msg.empty()
                bar.empty()
                st.success(f"ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†ï¼ä¸Šæ˜‡éŠ˜æŸ„: {len(show_df)}ä»¶")
                st.dataframe(show_df, use_container_width=True, hide_index=True)
            else:
                msg.empty()
                bar.empty()
                st.warning("ç¾åœ¨ã€ä¸Šæ˜‡ã—ã¦ã„ã‚‹éŠ˜æŸ„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚")
                
        except Exception as e:
            st.error(f"ã‚¨ãƒ©ãƒ¼: {e}")

# --- ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ ---
scan_ranking(TARGET_STOCKS)
