import streamlit as st
import pandas as pd
import yfinance as yf

# ページ設定
st.set_page_config(page_title="最強銘柄スキャナー・完全版", layout="wide")

# --- パスワード認証 ---
MY_PASSWORD = "stock testa" 
if 'auth' not in st.session_state: st.session_state.auth = False

if not st.session_state.auth:
    st.title("🔒 認証")
    pwd = st.text_input("パスワード", type="password")
    if pwd == MY_PASSWORD:
        st.session_state.auth = True
        st.rerun()
    st.stop()

st.title("⚡️ プライム市場・完全網羅スキャナー")
st.caption("約300銘柄を一括監視：前日比 × 寄付比 × テーマ")

# --- 銘柄データベース（コード: [銘柄名, テーマ]） ---
# 300銘柄以上を網羅しなおしました
STOCK_DB = {
    # --- 半導体・ハイテク ---
    "8035.T": ["東エレク", "半導体/製造装置"], "6920.T": ["レーザーテック", "EUV検査/半導体"],
    "6146.T": ["ディスコ", "半導体切断/生成AI"], "6857.T": ["アドバンテスト", "半導体テスタ/AI"],
    "7735.T": ["スクリン", "ウエハ洗浄"], "6723.T": ["ルネサス", "車載半導体"],
    "6526.T": ["ソシオネクスト", "先端SoC設計"], "6315.T": ["TOWA", "半導体モールディング"],
    "6871.T": ["日本マイクロ", "メモリ/プローブカード"], "6525.T": ["KOKUSAI", "成膜装置"],
    "6758.T": ["ソニーG", "画像センサ/エンタメ"], "6501.T": ["日立", "重電/IT/インフラ"],
    "6701.T": ["NEC", "防衛/サイバー/生体認証"], "6702.T": ["富士通", "DX/スパコン"],
    "6954.T": ["ファナック", "FA/ロボット"], "6861.T": ["キーエンス", "FAセンサ/高収益"],
    "6273.T": ["SMC", "空圧機器/FA"], "6981.T": ["村田製", "電子部品/スマホ"],
    "6762.T": ["TDK", "電池/電子部品"], "6971.T": ["京セラ", "電子部品/太陽光"],
    "6923.T": ["スタンレー", "自動車照明"], "6503.T": ["三菱電機", "FA/防衛/パワー半導体"],
    "6504.T": ["富士電機", "パワー半導体"], "6506.T": ["安川電機", "ロボット/FA"],
    "6976.T": ["太陽誘電", "積層セラミックコンデンサ"], "6988.T": ["日東電工", "高機能材料"],
    "6479.T": ["ミネベア", "ベアリング/精密"], "7751.T": ["キヤノン", "露光装置/カメラ"],
    "7733.T": ["オリンパス", "内視鏡"], "7741.T": ["HOYA", "ガラス基板/医療"],
    "4901.T": ["富士フイルム", "ヘルスケア/半導体材料"], "6752.T": ["パナソニック", "電池/家電"],
    "6841.T": ["横河電機", "制御計測"], "6645.T": ["オムロン", "制御機器/ヘルスケア"],
    "7701.T": ["島津製", "計測機器"], "6594.T": ["ニデック", "モータ/EV"],
    "6902.T": ["デンソー", "自動車部品/半導体"],

    # --- 電線・非鉄・素材 ---
    "5802.T": ["住友電工", "電線/送電網/DC"], "5803.T": ["フジクラ", "光ファイバ/生成AI"],
    "5801.T": ["古河電工", "電線/インフラ"], "5713.T": ["住友鉱", "金/銅/ニッケル"],
    "5711.T": ["三菱マ", "銅/セメント"], "5714.T": ["DOWA", "非鉄/リサイクル"],
    "5706.T": ["三井金", "亜鉛/銅箔"], "5726.T": ["大阪チタ", "チタン/航空機"],
    "5727.T": ["東邦チタ", "チタン/スポンジチタン"], "3436.T": ["SUMCO", "シリコンウエハ"],
    "5938.T": ["LIXIL", "建材/住宅設備"], "5401.T": ["日本製鉄", "鉄鋼/USスチール"],
    "5411.T": ["JFE", "鉄鋼大手"], "5406.T": ["神戸鋼", "鉄鋼/アルミ/機械"],
    "3407.T": ["旭化成", "化学/住宅"], "3402.T": ["東レ", "炭素繊維/素材"],
    "3401.T": ["帝人", "繊維/ヘルスケア"], "4188.T": ["三菱ケミ", "総合化学"],
    "4183.T": ["三井化学", "総合化学"], "4005.T": ["住友化学", "総合化学/農薬"],
    "4042.T": ["東ソー", "クロルアルカリ"], "4061.T": ["デンカ", "化学/ワクチン"],
    "4021.T": ["日産化学", "電子材料/農薬"], "4063.T": ["信越化学", "塩ビ/ウエハ世界一"],
    "4062.T": ["イビデン", "ICパッケージ"], "4631.T": ["DIC", "インキ/化学"],
    "5201.T": ["AGC", "ガラス/化学"], "5233.T": ["太平洋セメ", "セメント"],

    # --- 自動車・機械・重工 ---
    "7203.T": ["トヨタ", "自動車/全固体電池"], "7267.T": ["ホンダ", "自動車/二輪/EV"],
    "7201.T": ["日産自", "自動車/EV"], "7270.T": ["SUBARU", "北米好調/四駆"],
    "7269.T": ["スズキ", "軽自動車/インド"], "7211.T": ["三菱自", "自動車/ASEAN"],
    "7202.T": ["いすゞ", "トラック"], "7259.T": ["アイシン", "自動車部品/eAxle"],
    "7261.T": ["マツダ", "自動車"], "7272.T": ["ヤマハ発", "二輪/ロボット"],
    "5108.T": ["ブリヂストン", "タイヤ世界首位"], "7011.T": ["三菱重工", "防衛/原発/ガスタービン"],
    "7012.T": ["川崎重工", "防衛/二輪/ロボット"], "7013.T": ["IHI", "航空エンジン/防衛"],
    "6301.T": ["コマツ", "建機/鉱山機械"], "6305.T": ["日立建機", "建機"],
    "6326.T": ["クボタ", "農機/水環境"], "6005.T": ["三浦工業", "ボイラ"],
    "6113.T": ["アマダ", "板金機械"], "5631.T": ["日本製鋼所", "防衛/原発部材"],
    "7004.T": ["日立造船", "ごみ焼却/造船"], "6361.T": ["荏原", "ポンプ/半導体装置"],
    "6367.T": ["ダイキン", "空調世界一"], "6383.T": ["ダイフク", "物流システム"],
    "6417.T": ["SANKYO", "パチンコ"], "6460.T": ["セガサミー", "ゲーム/遊技機"],

    # --- 金融・商社 ---
    "8306.T": ["三菱UFJ", "メガバンク/金利上昇"], "8316.T": ["三井住友", "メガバンク/海外展開"],
    "8411.T": ["みずほ", "メガバンク/法人"], "8308.T": ["りそな", "銀行"],
    "8309.T": ["三井住友トラ", "信託銀行"], "8304.T": ["あおぞら", "銀行/海外不動産"],
    "8331.T": ["千葉銀", "地銀上位"], "8354.T": ["ふくおか", "地銀上位"],
    "7186.T": ["コンコルディア", "地銀上位"], "8410.T": ["セブン銀行", "ATM"],
    "8604.T": ["野村HD", "証券"], "8601.T": ["大和証券", "証券"],
    "8697.T": ["JPX", "取引所"], "8766.T": ["東京海上", "損保/政策株売却"],
    "8725.T": ["MS&AD", "損保"], "8630.T": ["SOMPO", "損保/ビッグモーター"],
    "8750.T": ["第一生命", "生保"], "8795.T": ["T&D", "生保"],
    "8591.T": ["オリックス", "リース/再エネ"], "8253.T": ["クレディセゾン", "カード/金融"],
    "7182.T": ["ゆうちょ", "銀行"], "8058.T": ["三菱商事", "総合商社/資源"],
    "8001.T": ["伊藤忠", "総合商社/非資源"], "8031.T": ["三井物産", "総合商社/エネルギー"],
    "8002.T": ["丸紅", "総合商社/電力"], "8015.T": ["豊田通商", "総合商社/自動車"],
    "2768.T": ["双日", "総合商社"], "8053.T": ["住友商事", "総合商社"],

    # --- 小売・その他 ---
    "9983.T": ["ファストリ", "ユニクロ/円安"], "3382.T": ["セブン&アイ", "コンビニ/買収"],
    "8267.T": ["イオン", "流通/金融"], "3099.T": ["三越伊勢丹", "百貨店/インバウンド"],
    "3086.T": ["Jフロント", "百貨店"], "8233.T": ["高島屋", "百貨店"],
    "9984.T": ["ソフトバンクG", "AI投資/ARM"], "7532.T": ["パンパシHD", "ドンキ/インバウンド"],
    "9843.T": ["ニトリ", "家具/円高メリット"], "3092.T": ["ZOZO", "EC/ファッション"],
    "2670.T": ["ABCマート", "靴/インバウンド"], "4911.T": ["資生堂", "化粧品/中国"],
    "4452.T": ["花王", "トイレタリー"],

    # --- インフラ・海運 ---
    "9101.T": ["日本郵船", "海運/コンテナ"], "9104.T": ["商船三井", "海運/エネルギー"],
    "9107.T": ["川崎汽船", "海運/還元期待"], "9201.T": ["JAL", "航空/インバウンド"],
    "9202.T": ["ANA", "航空/インバウンド"], "9020.T": ["JR東日本", "鉄道/不動産"],
    "9021.T": ["JR西日本", "鉄道/観光"], "9022.T": ["JR東海", "リニア/新幹線"],
    "9064.T": ["ヤマトHD", "物流"], "9143.T": ["SGHD", "佐川急便"],
    "9005.T": ["東急", "鉄道/不動産"], "9007.T": ["小田急", "鉄道/観光"],
    "9009.T": ["京成", "鉄道/OLC筆頭"], "9432.T": ["NTT", "通信/IOWN"],
    "9433.T": ["KDDI", "通信/ローソン"], "9434.T": ["ソフトバンク", "通信/PayPay"],
    "9613.T": ["NTTデータ", "SIer"], "9501.T": ["東電HD", "電力/原発"],
    "9502.T": ["中部電力", "電力"], "9503.T": ["関西電力", "電力/原発"],
    "9531.T": ["東京ガス", "ガス"], "9532.T": ["大阪ガス", "ガス"],
    "4689.T": ["LINEヤフー", "ネット/広告"], "4755.T": ["楽天G", "EC/モバイル"],
    "6098.T": ["リクルート", "人材/Indeed"], "4661.T": ["OLC", "ディズニー"],
    "2413.T": ["エムスリー", "医療DX"], "4385.T": ["メルカリ", "フリマアプリ"],
    "7974.T": ["任天堂", "ゲーム/Switch"], "9735.T": ["セコム", "警備"],
    "9602.T": ["東宝", "映画/不動産"], "4751.T": ["サイバー", "ネット広告/ゲーム"],

    # --- 医薬・食品 ---
    "4502.T": ["武田薬品", "医薬品/配当"], "4568.T": ["第一三共", "がん薬(ADC)"],
    "4519.T": ["中外製薬", "バイオ医薬"], "4503.T": ["アステラス", "医薬品"],
    "4507.T": ["塩野義", "感染症薬"], "4523.T": ["エーザイ", "認知症薬"],
    "4578.T": ["大塚HD", "医薬品/飲料"], "4528.T": ["小野薬品", "がん薬"],
    "4151.T": ["協和キリン", "バイオ"], "2502.T": ["アサヒ", "飲料/海外"],
    "2503.T": ["キリン", "飲料/ヘルスケア"], "2914.T": ["JT", "たばこ/高配当"],
    "2801.T": ["キッコーマン", "醤油/海外"], "2802.T": ["味の素", "食品/半導体材料"],
    "2267.T": ["ヤクルト", "飲料"], "2282.T": ["ニッハム", "食品"],
    "2269.T": ["明治HD", "食品/薬品"], "2897.T": ["日清食品", "即席麺"],

    # --- 建設・不動産 ---
    "1925.T": ["大和ハウス", "建設/DC"], "1928.T": ["積水ハウス", "住宅/海外"],
    "1801.T": ["大成建設", "ゼネコン"], "1802.T": ["大林組", "ゼネコン"],
    "1803.T": ["清水建設", "ゼネコン"], "1812.T": ["鹿島", "ゼネコン"],
    "1808.T": ["長谷工", "マンション"], "1944.T": ["きんでん", "電気工事"],
    "8801.T": ["三井不動産", "不動産/金利"], "8802.T": ["三菱地所", "不動産/丸の内"],
    "8830.T": ["住友不", "不動産/ビル"], "3289.T": ["東急不HD", "不動産/再エネ"]
}

def scan_market():
    if st.button('📡 市場をスキャンする', type="primary"):
        msg = st.empty()
        bar = st.progress(0)
        
        tickers = list(STOCK_DB.keys())
        msg.text(f"データ取得中... 対象: {len(tickers)}銘柄")
        
        try:
            # 5日分取得（前日終値を確実に計算するため）
            df = yf.download(tickers, period="5d", interval="1d", progress=False, group_by='ticker')
            
            bar.progress(50)
            msg.text("詳細分析中（前日比・寄付比）...")
            
            results = []
            for ticker in tickers:
                try:
                    info = STOCK_DB.get(ticker)
                    name = info[0]
                    theme = info[1]
                    
                    if ticker not in df.columns.levels[0]: continue
                    
                    data = df[ticker].dropna()
                    if len(data) < 2: continue
                    
                    # 今日のデータ
                    today = data.iloc[-1]
                    curr = today['Close']
                    op = today['Open']
                    
                    # 前日のデータ
                    yesterday = data.iloc[-2]
                    prev_close = yesterday['Close']
                    
                    if pd.isna(curr) or pd.isna(op) or op == 0 or prev_close == 0: continue
                    
                    # 計算
                    open_change = (curr - op) / op * 100 # 寄付比
                    day_change = (curr - prev_close) / prev_close * 100 # 前日比
                    
                    # 判定（状態）
                    status = ""
                    if open_change > 1.0 and day_change > 2.0: status = "🔥🔥 大陽線"
                    elif open_change > 2.0: status = "🚀 急伸"
                    elif day_change > 0 and open_change < -0.5: status = "⚠️ 失速"
                    elif day_change > 0.5 and open_change > 0: status = "📈 堅調"
                    elif day_change < -1.0: status = "📉 軟調"
                    else: status = "-"

                    results.append({
                        "コード": ticker.replace(".T", ""),
                        "銘柄名": name,
                        "寄付比": open_change,
                        "前日比": day_change,
                        "現在値": curr,
                        "状態": status,
                        "備考 (テーマ)": theme
                    })
                except: continue
            
            bar.progress(100)
            
            # ランキング表示
            rank_df = pd.DataFrame(results)
            if not rank_df.empty:
                # デフォルトは寄付比順
                rank_df = rank_df.sort_values(by="寄付比", ascending=False)
                # 前日比プラス銘柄のみ
                rank_df = rank_df[rank_df['前日比'] > 0]
                
                show_df = pd.DataFrame()
                show_df['コード'] = rank_df['コード']
                show_df['銘柄名'] = rank_df['銘柄名']
                show_df['寄付比'] = rank_df['寄付比'].map(lambda x: f"+{x:.2f}%" if x>0 else f"{x:.2f}%")
                show_df['前日比'] = rank_df['前日比'].map(lambda x: f"+{x:.2f}%" if x>0 else f"{x:.2f}%")
                show_df['現在値'] = rank_df['現在値'].map(lambda x: f"{x:,.0f}")
                # ユーザー指定：状態 → 備考の順
                show_df['状態'] = rank_df['状態']
                show_df['備考 (テーマ)'] = rank_df['備考 (テーマ)']
                
                msg.empty()
                bar.empty()
                st.success(f"スキャン完了！強勢銘柄: {len(show_df)}件 (対象: {len(tickers)}社)")
                
                st.dataframe(
                    show_df,
                    use_container_width=True,
                    hide_index=True,
                    column_config={
                        "状態": st.column_config.TextColumn("状態", width="small"),
                        "備考 (テーマ)": st.column_config.TextColumn("備考 (テーマ)", width="medium"),
                        "寄付比": st.column_config.TextColumn("寄付比", help="始値からの上昇率"),
                        "前日比": st.column_config.TextColumn("前日比", help="前日終値からの上昇率"),
                    }
                )
            else:
                msg.empty()
                bar.empty()
                st.warning("現在、上昇トレンドの銘柄はありません。")
                
        except Exception as e:
            st.error(f"エラー: {e}")

# --- メイン実行 ---
scan_market()
