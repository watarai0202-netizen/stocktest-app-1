import streamlit as st
import pandas as pd
import yfinance as yf

# ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(page_title="æœ€å¼·éŠ˜æŸ„ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ãƒ»å®Œ", layout="wide")

# --- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ ---
MY_PASSWORD = "stock testa" 
if 'auth' not in st.session_state: st.session_state.auth = False

if not st.session_state.auth:
    st.title("ğŸ”’ èªè¨¼")
    pwd = st.text_input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", type="password")
    if pwd == MY_PASSWORD:
        st.session_state.auth = True
        st.rerun()
    st.stop()

st.title("âš¡ï¸ å…¨è‡ªå‹•ãƒãƒ¼ã‚±ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒŠãƒ¼")
st.caption("ã‚¯ãƒ©ã‚¦ãƒ‰ç¨¼åƒç‰ˆï¼šä¸»è¦æ¿€å‹•éŠ˜æŸ„ã®ã€Œç¤¾åä»˜ãã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–")

# --- ç›£è¦–ãƒªã‚¹ãƒˆï¼ˆã‚³ãƒ¼ãƒ‰ã¨ç¤¾åã®ã‚»ãƒƒãƒˆï¼‰ ---
# ã“ã“ã«ã‚ã‚‹éŠ˜æŸ„ã‚’å…¨è‡ªå‹•ã§ãƒã‚§ãƒƒã‚¯ã—ã¾ã™
TARGET_STOCKS = {
    "ã‚°ãƒ­ãƒ¼ã‚¹ãƒ»æ–°èˆˆ": {
        "5253.T": "ã‚«ãƒãƒ¼", "5032.T": "ANYCOLOR", "9166.T": "GENDA", "5595.T": "QPSç ”ç©¶æ‰€",
        "5892.T": "yutori", "5574.T": "ABEJA", "5586.T": "LaboroAI", "2160.T": "GNI",
        "4592.T": "ã‚µãƒ³ãƒã‚¤ã‚ª", "4478.T": "ãƒ•ãƒªãƒ¼", "4483.T": "JMDC", "7342.T": "ã‚¦ã‚§ãƒ«ã‚¹ãƒŠãƒ“",
        "7779.T": "ã‚µã‚¤ãƒãƒ¼ãƒ€ã‚¤ãƒ³", "9552.T": "M&Aç·ç ”", "9553.T": "ãƒã‚¤ã‚¯ãƒ­ã‚¢ãƒ‰", "3133.T": "æµ·å¸†",
        "7014.T": "åæ‘é€ èˆ¹", "6254.T": "é‡æ‘ãƒã‚¤ã‚¯ãƒ­", "6298.T": "ãƒ¯ã‚¤ã‚¨ã‚¤ã‚·ã‚¤", "6228.T": "ã‚¸ã‚§ã‚¤ã‚¤ãƒ¼ãƒ†ã‚£",
        "3993.T": "PKSHA", "3903.T": "gumi", "4565.T": "ãƒã‚¯ã‚»ãƒ©", "4169.T": "ã‚¨ãƒãƒã‚§ãƒ³ã‚¸",
        "4165.T": "ãƒ—ãƒ¬ã‚¤ãƒ‰", "4443.T": "Sansan", "4011.T": "ãƒ˜ãƒƒãƒ‰ã‚¦ã‚©ãƒ¼ã‚¿", "4425.T": "Kudan",
        "4385.T": "ãƒ¡ãƒ«ã‚«ãƒª", "2934.T": "ã‚¸ã‚§ã‚¤ãƒ•ãƒ­ãƒ³ãƒ†ã‚£ã‚¢", "2936.T": "ãƒ™ãƒ¼ã‚¹ãƒ•ãƒ¼ãƒ‰", "4485.T": "JTOWER",
        "7071.T": "ã‚¢ãƒ³ãƒ“ã‚¹", "7370.T": "Enjin", "9229.T": "ã‚µãƒ³ã‚¦ã‚§ãƒ«ã‚º", "9219.T": "ã‚®ãƒƒã‚¯ã‚¹",
        "9252.T": "ãƒ©ã‚¹ãƒˆãƒ¯ãƒ³ãƒã‚¤ãƒ«", "4894.T": "ã‚¯ã‚ªãƒªãƒ—ã‚¹", "4893.T": "ãƒã‚¤ãƒ«ã‚¤ãƒŸãƒ¥ãƒ¼ãƒ³", "4575.T": "ã‚­ãƒ£ãƒ³ãƒã‚¹",
        "5240.T": "monoAI", "5243.T": "ãƒãƒ¼ãƒˆ", "5244.T": "jig.jp", "5254.T": "Arent",
        "5255.T": "ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãƒ©ãƒœ", "5258.T": "ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³", "5591.T": "AVILEN", "5592.T": "ãã™ã‚Šã®çª“å£"
    },
    "ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ»ææ–™": {
        "6890.T": "ãƒ•ã‚§ãƒ­ãƒ¼ãƒ†ãƒƒã‚¯", "2782.T": "ã‚»ãƒªã‚¢", "7564.T": "ãƒ¯ãƒ¼ã‚¯ãƒãƒ³", "2702.T": "ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰",
        "6324.T": "ãƒãƒ¼ãƒ¢ãƒ‹ãƒƒã‚¯", "4970.T": "æ±æ´‹åˆæˆ", "3854.T": "ã‚¢ã‚¤ãƒ«", "6425.T": "ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«",
        "6613.T": "QDãƒ¬ãƒ¼ã‚¶", "5809.T": "ã‚¿ãƒ„ã‚¿ç·š", "6622.T": "ãƒ€ã‚¤ãƒ˜ãƒ³", "6630.T": "ãƒ¤ãƒ¼ãƒãƒ³",
        "3825.T": "ãƒªãƒŸãƒƒã‚¯ã‚¹", "3810.T": "ã‚µã‚¤ãƒãƒ¼ã‚¹ãƒ†ãƒƒãƒ—", "3624.T": "ã‚¢ã‚¯ã‚»ãƒ«ãƒãƒ¼ã‚¯", "3323.T": "ãƒ¬ã‚«ãƒ ",
        "2370.T": "ãƒ¡ãƒ‡ã‚£ãƒãƒƒãƒˆ", "4572.T": "ã‚«ãƒ«ãƒŠãƒã‚¤ã‚ª", "4579.T": "ãƒ©ã‚¯ã‚ªãƒªã‚¢", "4564.T": "OTS",
        "2134.T": "ç‡¦ã‚­ãƒ£ãƒ”ã‚¿ãƒ«", "5721.T": "ã‚¨ã‚¹ãƒ»ã‚µã‚¤ã‚¨ãƒ³ã‚¹", "3041.T": "ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£èŠ±å£‡", "3121.T": "ãƒãƒ¼ãƒãƒ£ãƒ³ãƒˆ",
        "6659.T": "ãƒ¡ãƒ‡ã‚£ã‚¢ãƒªãƒ³ã‚¯ã‚¹", "6696.T": "ãƒˆãƒ©ãƒ¼ã‚¹OP", "6731.T": "ãƒ”ã‚¯ã‚·ãƒ¼ãƒ€ã‚¹ãƒˆ", "3778.T": "ã•ãã‚‰",
        "3350.T": "ãƒ¡ã‚¿ãƒ—ãƒ©ãƒãƒƒãƒˆ", "2330.T": "ãƒ•ã‚©ãƒ¼ã‚µã‚¤ãƒ‰", "7163.T": "ä½ä¿¡SBI", "4712.T": "KeyHolder"
    },
    "ãƒ—ãƒ©ã‚¤ãƒ ãƒ»ä¸»åŠ›": {
        "6920.T": "ãƒ¬ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒƒã‚¯", "8035.T": "æ±ã‚¨ãƒ¬ã‚¯", "6146.T": "ãƒ‡ã‚£ã‚¹ã‚³", "6857.T": "ã‚¢ãƒ‰ãƒãƒ³ãƒ†ã‚¹ãƒˆ",
        "7735.T": "ã‚¹ã‚¯ãƒªãƒ³", "6526.T": "ã‚½ã‚·ã‚ªãƒã‚¯ã‚¹ãƒˆ", "6758.T": "ã‚½ãƒ‹ãƒ¼G", "6723.T": "ãƒ«ãƒã‚µã‚¹",
        "6981.T": "æ‘ç”°è£½", "6762.T": "TDK", "6954.T": "ãƒ•ã‚¡ãƒŠãƒƒã‚¯", "6501.T": "æ—¥ç«‹",
        "6367.T": "ãƒ€ã‚¤ã‚­ãƒ³", "6594.T": "ãƒ‹ãƒ‡ãƒƒã‚¯", "3436.T": "SUMCO", "4063.T": "ä¿¡è¶ŠåŒ–å­¦",
        "7203.T": "ãƒˆãƒ¨ã‚¿", "7267.T": "ãƒ›ãƒ³ãƒ€", "7201.T": "æ—¥ç”£è‡ª", "7011.T": "ä¸‰è±é‡å·¥",
        "7012.T": "å·å´é‡å·¥", "7013.T": "IHI", "8058.T": "ä¸‰è±å•†äº‹", "8001.T": "ä¼Šè—¤å¿ ",
        "8031.T": "ä¸‰äº•ç‰©ç”£", "5401.T": "æ—¥æœ¬è£½é‰„", "5411.T": "JFE", "8306.T": "ä¸‰è±UFJ",
        "8316.T": "ä¸‰äº•ä½å‹", "8411.T": "ã¿ãšã»", "8766.T": "æ±äº¬æµ·ä¸Š", "9101.T": "æ—¥æœ¬éƒµèˆ¹",
        "9104.T": "å•†èˆ¹ä¸‰äº•", "9107.T": "å·å´æ±½èˆ¹", "9984.T": "ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯G", "9983.T": "ãƒ•ã‚¡ã‚¹ãƒˆãƒª",
        "3382.T": "ã‚»ãƒ–ãƒ³&ã‚¢ã‚¤", "6098.T": "ãƒªã‚¯ãƒ«ãƒ¼ãƒˆ", "4661.T": "OLC", "4502.T": "æ­¦ç”°è–¬å“",
        "4568.T": "ç¬¬ä¸€ä¸‰å…±", "4519.T": "ä¸­å¤–è£½è–¬", "2914.T": "JT", "7974.T": "ä»»å¤©å ‚",
        "9501.T": "æ±é›»HD", "9432.T": "NTT", "9433.T": "KDDI", "4385.T": "ãƒ¡ãƒ«ã‚«ãƒª"
    }
}

def scan_ranking(category, stock_dict):
    if st.button(f'ğŸ“¡ {category} ã‚’ã‚¹ã‚­ãƒ£ãƒ³', key=category):
        # é€²è¡ŒçŠ¶æ³è¡¨ç¤º
        msg = st.empty()
        msg.text("ãƒ‡ãƒ¼ã‚¿åé›†ä¸­...ï¼ˆæ•°ç§’ãŠå¾…ã¡ãã ã•ã„ï¼‰")
        
        tickers = list(stock_dict.keys())
        
        try:
            # yfinanceã§ä¸€æ‹¬å–å¾—
            df = yf.download(tickers, period="1d", interval="1d", progress=False, group_by='ticker')
            
            msg.text("ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”Ÿæˆä¸­...")
            
            results = []
            for ticker in tickers:
                try:
                    name = stock_dict[ticker] # ç¤¾åã‚’å–å¾—
                    
                    # ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ç¢ºèª
                    if ticker not in df.columns.levels[0]:
                        continue
                    
                    # ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
                    data = df[ticker].iloc[-1]
                    curr = data['Close']
                    op = data['Open']
                    
                    if pd.isna(curr) or pd.isna(op) or op == 0:
                        continue
                    
                    # å¯„ä»˜æ¯”ï¼ˆå§‹å€¤ã‹ã‚‰ã®ä¸Šæ˜‡ç‡ï¼‰
                    change = (curr - op) / op * 100
                    
                    # åˆ¤å®š
                    status = ""
                    if change > 5.0: status = "ğŸ”¥ğŸ”¥ æ€¥é¨°"
                    elif change > 3.0: status = "ğŸš€ å¼·ã„"
                    elif change > 1.0: status = "ğŸ“ˆ å …èª¿"
                    elif change < -2.0: status = "ğŸ“‰ å¼±ã„"
                    else: status = "-"

                    results.append({
                        "éŠ˜æŸ„å": name,
                        "ã‚³ãƒ¼ãƒ‰": ticker.replace(".T", ""),
                        "å¯„ä»˜æ¯”": change,
                        "ç¾åœ¨å€¤": curr,
                        "åˆ¤å®š": status
                    })
                except:
                    continue
            
            # ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
            rank_df = pd.DataFrame(results)
            if not rank_df.empty:
                rank_df = rank_df.sort_values(by="å¯„ä»˜æ¯”", ascending=False)
                # ä¸Šæ˜‡ã—ã¦ã„ã‚‹ã‚‚ã®ã ã‘è¡¨ç¤º
                rank_df = rank_df[rank_df['å¯„ä»˜æ¯”'] > 0]
                
                # è¡¨ç¤ºç”¨ã«æ•´å½¢
                show_df = pd.DataFrame()
                show_df['éŠ˜æŸ„å'] = rank_df['éŠ˜æŸ„å']
                show_df['ã‚³ãƒ¼ãƒ‰'] = rank_df['ã‚³ãƒ¼ãƒ‰']
                show_df['å¯„ä»˜æ¯”'] = rank_df['å¯„ä»˜æ¯”'].map(lambda x: f"+{x:.2f}%")
                show_df['ç¾åœ¨å€¤'] = rank_df['ç¾åœ¨å€¤'].map(lambda x: f"{x:,.0f}")
                show_df['åˆ¤å®š'] = rank_df['åˆ¤å®š']
                
                msg.empty() 
                st.success(f"ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†ï¼ä¸Šæ˜‡éŠ˜æŸ„: {len(show_df)}ä»¶")
                st.dataframe(show_df, use_container_width=True, hide_index=True)
            else:
                msg.empty()
                st.warning("ç¾åœ¨ã€ä¸Šæ˜‡ã—ã¦ã„ã‚‹éŠ˜æŸ„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚")
                
        except Exception as e:
            st.error(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

# --- ãƒ¡ã‚¤ãƒ³ç”»é¢ ---
t1, t2, t3 = st.tabs(["ğŸš€ ã‚°ãƒ­ãƒ¼ã‚¹", "ğŸ¢ ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰", "ğŸ¦ ãƒ—ãƒ©ã‚¤ãƒ "])
with t1: scan_ranking("ã‚°ãƒ­ãƒ¼ã‚¹ãƒ»æ–°èˆˆ", TARGET_STOCKS["ã‚°ãƒ­ãƒ¼ã‚¹ãƒ»æ–°èˆˆ"])
with t2: scan_ranking("ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ»ææ–™", TARGET_STOCKS["ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ»ææ–™"])
with t3: scan_ranking("ãƒ—ãƒ©ã‚¤ãƒ ãƒ»ä¸»åŠ›", TARGET_STOCKS["ãƒ—ãƒ©ã‚¤ãƒ ãƒ»ä¸»åŠ›"])
